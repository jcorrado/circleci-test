version: 2.0
jobs:
  build:
    environment:
      PROD_LOGSTASH_ADDR: 172.31.15.184
    machine: true
    steps:
      - checkout
      - run:
          name: Build Logstash Test Container
          command: docker build -t logstash .
      - run:
          name: Launch Logstash Test Container
          command: |
            mkdir artifacts
            docker run -d --name=logstash \
            -v $(pwd)/conf:/etc/logstash/conf.d \
            -v $(pwd)/artifacts:/artifacts \
            logstash
      - run:
          name: Extract Container Addresses
          command: |
            IP_ADDR=$( docker inspect logstash | jq -r '.[0].NetworkSettings.Networks.bridge.IPAddress')
            MAC_ADDR=$(docker inspect logstash | jq -r '.[0].NetworkSettings.Networks.bridge.MacAddress')
            echo IP_ADDR=$IP_ADDR | tee -a $BASH_ENV
            echo MAC_ADDR=$MAC_ADDR | tee -a $BASH_ENV
      - run:
          name: Install Testing Tools
          command: |
            sudo apt-get -y -qq update
            sudo apt-get -y install tcpdump tcpreplay jq
      - run:
          name: Rewrite Test Capture For Target Logstash Container
          command: |
            tcprewrite --fixcsum -i test/caps/latest.pcap -o test.pcap --dstipmap=${PROD_LOGSTASH_ADDR}/32:$IP_ADDR/32 --enet-dmac=$MAC_ADDR
            sudo tcpdump -c 10 -enr test.pcap | grep -P "$MAC_ADDR.+?$IP_ADDR"
      - run:
          name: Replay Capture Against Logstash Container
          command: |
            ./bin/wait-for-it.sh --host=$IP_ADDR --port=9600 --timeout=300
            sudo tcpreplay -i docker0 --pps 100 test.pcap
      - run:
          name: Shutdown Logstash Container
          command: docker stop logstash
      - run:
          name: Save Logstash Daemon Log'
          command: docker logs logstash > artifacts/logstash_daemon.log
      - store_artifacts:
          path: artifacts
          prefix: logstash
